<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YouTube Subtitle Downloader</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", system-ui, sans-serif;
      }

      body {
        margin: 0;
        padding: 24px;
        background: #f6f7fb;
        color: #1e1e1e;
      }

      main {
        max-width: 960px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
      }

      h1 {
        margin-top: 0;
        font-size: 1.8rem;
      }

      label {
        font-weight: 600;
      }

      .controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: flex-end;
      }

      input[type="text"] {
        flex: 1 1 280px;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #cfd4df;
        font-size: 1rem;
      }

      button {
        border: none;
        border-radius: 8px;
        padding: 12px 18px;
        font-size: 0.95rem;
        cursor: pointer;
        background: #3f5efb;
        color: #ffffff;
      }

      button.secondary {
        background: #e6e9f5;
        color: #2c2f3a;
      }

      section {
        margin-top: 24px;
      }

      .output {
        display: grid;
        gap: 12px;
      }

      .output textarea {
        width: 100%;
        min-height: 80px;
        border-radius: 8px;
        border: 1px solid #cfd4df;
        padding: 10px;
        resize: vertical;
        font-family: inherit;
      }

      .log-area {
        background: #0f172a;
        color: #dbeafe;
        border-radius: 12px;
        padding: 16px;
        min-height: 140px;
        max-height: 220px;
        overflow-y: auto;
        font-family: "SFMono-Regular", ui-monospace, "Courier New", monospace;
        font-size: 0.85rem;
      }

      .status {
        margin-top: 12px;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>YouTube Subtitle Downloader</h1>
      <p>
        Enter a YouTube video ID or full URL to download the spoken-language
        subtitles via yt-dlp.
      </p>

      <div class="controls">
        <div>
          <label for="videoId">YouTube video ID or URL</label>
          <input
            id="videoId"
            type="text"
            placeholder="dQw4w9WgXcQ"
            autocomplete="off"
          />
        </div>
        <button id="downloadBtn">Download subtitles</button>
      </div>

      <div class="status" id="status">Status: Idle</div>

      <section>
        <h2>Subtitle Preview</h2>
        <div class="output">
          <label for="startText">Beginning of subtitle text</label>
          <textarea id="startText" readonly></textarea>
          <label for="endText">End of subtitle text</label>
          <textarea id="endText" readonly></textarea>
          <button class="secondary" id="copyBtn">Copy to clipboard</button>
        </div>
      </section>

      <section>
        <h2>Processing log</h2>
        <div class="log-area" id="logArea"></div>
      </section>
    </main>

    <script>
      const statusEl = document.getElementById("status");
      const logArea = document.getElementById("logArea");
      const startText = document.getElementById("startText");
      const endText = document.getElementById("endText");
      const downloadBtn = document.getElementById("downloadBtn");
      const copyBtn = document.getElementById("copyBtn");
      const videoIdInput = document.getElementById("videoId");

      let socket;

      const appendLog = (message) => {
        const line = document.createElement("div");
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logArea.appendChild(line);
        logArea.scrollTop = logArea.scrollHeight;
      };

      const setStatus = (text) => {
        statusEl.textContent = `Status: ${text}`;
      };

      const connectSocket = () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
          return;
        }
        socket = new WebSocket(`ws://${window.location.host}/ws`);
        socket.addEventListener("open", () => {
          appendLog("WebSocket connected.");
          setStatus("Connected");
        });
        socket.addEventListener("close", () => {
          appendLog("WebSocket disconnected.");
          setStatus("Disconnected");
        });
        socket.addEventListener("message", (event) => {
          const payload = JSON.parse(event.data);
          if (payload.type === "log") {
            appendLog(payload.message);
          }
          if (payload.type === "result") {
            startText.value = payload.start || "";
            endText.value = payload.end || "";
            setStatus("Complete");
          }
          if (payload.type === "error") {
            appendLog(`Error: ${payload.message}`);
            setStatus("Error");
          }
        });
      };

      const requestDownload = () => {
        const videoId = videoIdInput.value.trim();
        if (!videoId) {
          appendLog("Please enter a YouTube video ID.");
          return;
        }
        connectSocket();
        setStatus("Sending request");
        appendLog("Submitting download request...");
        socket.send(
          JSON.stringify({
            type: "download",
            videoId,
          })
        );
      };

      const copyText = async () => {
        const text = `${startText.value}\n\n${endText.value}`.trim();
        if (!text) {
          appendLog("Nothing to copy.");
          return;
        }
        try {
          await navigator.clipboard.writeText(text);
          appendLog("Copied to clipboard via Clipboard API.");
          return;
        } catch (error) {
          appendLog("Clipboard API failed, using execCommand fallback.");
        }
        const temp = document.createElement("textarea");
        temp.value = text;
        document.body.appendChild(temp);
        temp.select();
        try {
          document.execCommand("copy");
          appendLog("Copied to clipboard via execCommand.");
        } catch (error) {
          appendLog("Copy failed.");
        }
        document.body.removeChild(temp);
      };

      downloadBtn.addEventListener("click", requestDownload);
      copyBtn.addEventListener("click", copyText);
      connectSocket();
    </script>
  </body>
</html>
